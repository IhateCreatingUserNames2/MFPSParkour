using UnityEngine;
using System.Collections;
using MFPS;
using MFPS.InputManager;
using FC_ParkourSystem;

namespace FC_ParkourSystem
{
    public class MFPS_IntegrationHelper : MonoBehaviour, IParkourCharacter
    {
        ParkourController parkourController;
        ClimbController climbController;
        bl_FirstPersonController firstPersonController;
        Animator animator;
        Collider playerCollider;
        bl_PlayerCameraSwitcher cameraSwitcher;
        bl_PlayerAnimations playerAnimations;
        AnimatorHelper animatorHelper;

        public bool UseRootMotion { get; set; } = false;
        public Vector3 MoveDir => firstPersonController.transform.forward * firstPersonController.Velocity.magnitude;
        public bool IsGrounded => firstPersonController.isGrounded;
        public float Gravity => -9.81f;

        public Animator Animator
        {
            get { return animator == null ? GetComponent<Animator>() : animator; }
            set { animator = value; }
        }

        private void Awake()
        {
            InitializeComponents();
        }

        private void InitializeComponents()
        {
            parkourController = GetComponent<ParkourController>();
            climbController = GetComponent<ClimbController>();
            firstPersonController = GetComponent<bl_FirstPersonController>();
            playerCollider = GetComponent<Collider>();
            animator = GetComponent<Animator>();
            cameraSwitcher = GetComponent<bl_PlayerCameraSwitcher>();
            playerAnimations = GetComponent<bl_PlayerAnimations>();
            animatorHelper = GetComponent<AnimatorHelper>();

            if (AreRequiredComponentsMissing())
            {
                Debug.LogError("Missing required components for MFPS_IntegrationHelper.");
                this.enabled = false;
                return;
            }

            InitializeAnimatorHelper();
        }

        private bool AreRequiredComponentsMissing()
        {
            return parkourController == null || climbController == null || firstPersonController == null ||
                   playerCollider == null || animator == null || cameraSwitcher == null || playerAnimations == null || animatorHelper == null;
        }

        private void InitializeAnimatorHelper()
        {
            if (animatorHelper != null)
            {
                animatorHelper.initialize(animator);
            }
        }

        public void OnEndParkourAction()
        {
            if (firstPersonController != null) firstPersonController.enabled = true;
            if (playerCollider != null) playerCollider.enabled = true;
            if (cameraSwitcher != null) cameraSwitcher.enabled = true;
        }

        public void OnStartParkourAction()
        {
            if (firstPersonController != null)
            {
                firstPersonController.Velocity = Vector3.zero;
                firstPersonController.enabled = false;
            }
            if (playerCollider != null) playerCollider.enabled = false;
            if (cameraSwitcher != null) cameraSwitcher.enabled = false;
        }

        private void Update()
        {
            HandleInputs();
            if (parkourController != null && !parkourController.ControlledByParkour)
            {
                firstPersonController.OnUpdate();
            }
        }

        private void FixedUpdate()
        {
            if (parkourController != null && parkourController.ControlledByParkour)
            {
                firstPersonController.mouseLook.Update();
                firstPersonController.mouseLook.UpdateLook(firstPersonController.transform, firstPersonController.headRoot);
            }
            else if (firstPersonController != null)
            {
                firstPersonController.FixedUpdate();
            }
        }

        private void HandleInputs()
        {
            float horizontal = bl_Input.HorizontalAxis;
            float vertical = bl_Input.VerticalAxis;
            bool jump = bl_InputData.Instance.GetButtonDown("Jump");
            bool crouch = bl_InputData.Instance.GetButtonDown("Crouch");
            bool drop = bl_InputData.Instance.GetButtonDown("Drop");
            bool sprint = bl_InputData.Instance.GetButton("Sprint");

            Vector3 move = new Vector3(horizontal, 0, vertical);
            animator.SetFloat("Speed", move.magnitude);

            if (move != Vector3.zero)
            {
                MoveCharacter(horizontal, vertical, sprint);
            }

            if (jump)
            {
                HandleJump();
            }

            if (crouch)
            {
                HandleCrouch();
            }

            if (drop)
            {
                HandleDrop();
            }
        }

        private void MoveCharacter(float horizontal, float vertical, bool sprint)
        {
            if (firstPersonController != null)
            {
                firstPersonController.MovementInput();
                if (sprint)
                {
                    firstPersonController.State = PlayerState.Running;
                }
                else
                {
                    firstPersonController.State = PlayerState.Walking;
                }
            }
        }

        private void HandleJump()
        {
            if (firstPersonController != null && firstPersonController.isGrounded && parkourController != null)
            {
                animator.SetTrigger("Jump");
                parkourController.VerticalJump();
            }
        }

        private void HandleCrouch()
        {
            if (firstPersonController != null)
            {
                if (firstPersonController.Crounching)
                {
                    firstPersonController.State = PlayerState.Crouching;
                }
                else
                {
                    firstPersonController.State = PlayerState.Walking;
                }
            }
        }

        private void HandleDrop()
        {
            if (climbController != null && !parkourController.InAction)
            {
                if (bl_InputData.Instance.GetButtonDown("Drop"))
                {
                    if (climbController.envScanner.DropLedgeCheck(transform.forward, out ClimbLedgeData ledgeData))
                    {
                        var currentLedge = ledgeData.ledgeHit.transform;
                        var newPoint = climbController.GetNearestPoint(currentLedge, ledgeData.ledgeHit.point, false, obstacleCheck: false);

                        if (newPoint == null) return;

                        var currentPoint = newPoint;

                        OnStartParkourAction();

                        if (climbController.CheckWall(currentPoint).Value.isWall)
                        {
                            animator.SetFloat("freeHang", 0);
                            StartCoroutine(climbController.JumpToLedge(currentPoint.transform, "DropToHang", 0.50f, 0.90f, rotateToLedge: true, matchStart: AvatarTarget.LeftFoot));
                        }
                        else
                        {
                            animator.SetFloat("freeHang", 1);
                            StartCoroutine(climbController.JumpToLedge(currentPoint.transform, "DropToFreeHang", 0.50f, 0.89f, rotateToLedge: true, matchStart: AvatarTarget.LeftFoot));
                        }
                    }
                }
            }
        }

        public IEnumerator HandleVerticalJump()
        {
            if (firstPersonController != null && firstPersonController.isGrounded)
            {
                firstPersonController.DoJump();
            }
            yield break;
        }

        public bool PreventParkourAction => firstPersonController != null &&
                                            (firstPersonController.State == PlayerState.Crouching || firstPersonController.State == PlayerState.Running);
    }
}
